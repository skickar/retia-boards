name: Compile 
on: 
  schedule:
    - cron: "0 10 * * *"
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get latest meshtastic version 
        id: latest_meshtastic_tag
        run: |
          result=$(curl -sL https://api.github.com/repos/meshtastic/firmware/releases/latest | jq -r '.tag_name' )
          echo "result=$result" >> $GITHUB_OUTPUT

      # --- COMMENTED OUT TO ALLOW RE-BUILDS FOR TESTING ---
      # - name: Check if release exists locally
      #   id: check_release
      #   env: 
      #     RELEASE_TAG: ${{ steps.latest_meshtastic_tag.outputs.result }}
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: | 
      #     set -e
      #     if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
      #       echo "exists=true" >> "$GITHUB_OUTPUT"
      #     else
      #       echo "exists=false" >> "$GITHUB_OUTPUT"
      #     fi

      # - name: Exit if release already exists
      #   if: steps.check_release.outputs.exists == 'true'
      #   run: | 
      #     echo "Release for this version already exists. Exiting."
      #     exit 1
      # -----------------------------------------------------

      - name: Install platformIO cli
        run: |
          curl -fsSL -o get-platformio.py https://raw.githubusercontent.com/platformio/platformio-core-installer/master/get-platformio.py
          python3 get-platformio.py
      
      - name: Install meshtastic firmware
        run: |
          git clone https://github.com/meshtastic/firmware /home/runner/meshtastic

      - name: Move retia board files 
        run: |
          cp ${{ github.workspace }}/variants/retia-nibble /home/runner/meshtastic/variants/ -r
      
      - name: Inject Custom Environment to PlatformIO
        run: |
          # FIX: We use the spelling 'nibble-zero-connet' in the -I flag to match your repo folder
          cat <<EOF >> /home/runner/meshtastic/platformio.ini

          [env:nibble-zero-connect]
          extends = esp32s3_base
          board = esp32-s3-zero
          board_level = pr
          board_check = true
          build_flags = 
            \${esp32_base.build_flags}
            -D PRIVATE_HW
            -I variants/retia-nibble/nibble-zero-connet
            -D UART1_TX_PIN=-1
            -D UART1_RX_PIN=-1
            -D PIN_I2S_SD=-1
            -D PIN_I2S_WS=-1
            -D PIN_I2S_SCK=-1
            -D PIN_GPIO18=-1
          EOF
  
      - name: build
        # Removed continue-on-error so we see if it fails immediately
        run: |
          set +e
          mkdir -p /home/runner/dists
          shopt -s nullglob

          # We only build your specific target
          target="nibble-zero-connect"
          echo "Building target: $target"

          /home/runner/.platformio/penv/bin/platformio run \
            --project-dir /home/runner/meshtastic/ \
            -e "$target"

          if [ $? -eq 0 ]; then
            echo "Build Success!"
            build_dir="/home/runner/meshtastic/.pio/build/${target}"
            bin_files=("${build_dir}"/*.bin)
            
            if [ ${#bin_files[@]} -gt 0 ]; then
               zip -j "/home/runner/dists/${target}.zip" "${bin_files[@]}"
            else
               echo "ERROR: Build succeeded but no .bin files found."
               exit 1
            fi
          else
            echo "Build Failed."
            exit 1
          fi

      # CHANGED: Upload as Artifact (Zip file) instead of Release
      # This is much better for testing and won't fail if the tag exists
      - name: Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nibble-zero-connect-firmware
          path: /home/runner/dists/*.zip

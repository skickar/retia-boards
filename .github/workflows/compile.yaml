name: Compile 
on: 
  schedule:
    - cron: "0 10 * * *"
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Get latest meshtastic version 
        id: latest_meshtastic_tag
        run: |
          result=$(curl -sL https://api.github.com/repos/meshtastic/firmware/releases/latest | jq -r '.tag_name' )
          echo "result=$result" >> $GITHUB_OUTPUT

      - name: Install platformIO cli
        run: |
          curl -fsSL -o get-platformio.py https://raw.githubusercontent.com/platformio/platformio-core-installer/master/get-platformio.py
          python3 get-platformio.py
      
      - name: Install meshtastic firmware
        run: |
          git clone https://github.com/meshtastic/firmware /home/runner/meshtastic

      - name: Install Custom Variant
        run: |
          # 1. Find the folder (Handles 'nibble-zero-connet' OR 'nibble-zero-connect')
          SRC_PATH=$(find ${{ github.workspace }}/variants/retia-nibble -maxdepth 1 -name "nibble-zero-conne*" -type d | head -n 1)
          
          if [ -z "$SRC_PATH" ]; then
            echo "ERROR: Could not find nibble-zero-connect folder in variants/retia-nibble/"
            ls -R ${{ github.workspace }}/variants/
            exit 1
          fi

          echo "Found variant source at: $SRC_PATH"
          
          # 2. Copy it to the standard Meshtastic variants location with the CORRECT name
          # This ensures PlatformIO finds 'variant.h' automatically
          cp -r "$SRC_PATH" /home/runner/meshtastic/variants/nibble-zero-connect

      - name: Inject Custom Environment to PlatformIO
        run: |
          # We use 'board_build.variant' to let PIO handle the include paths
          cat <<EOF >> /home/runner/meshtastic/platformio.ini

          [env:nibble-zero-connect]
          extends = esp32s3_base
          board = esp32-s3-zero
          board_level = pr
          board_check = true
          
          ; TELL PIO TO USE THE FOLDER WE JUST COPIED
          board_build.variant = nibble-zero-connect
          
          build_flags = 
            \${esp32_base.build_flags}
            -D PRIVATE_HW
            ; Safety Flags to prevent crash
            -D UART1_TX_PIN=-1
            -D UART1_RX_PIN=-1
            -D PIN_I2S_SD=-1
            -D PIN_I2S_WS=-1
            -D PIN_I2S_SCK=-1
            -D PIN_GPIO18=-1
          EOF
  
      - name: build
        run: |
          set +e
          mkdir -p /home/runner/dists
          target="nibble-zero-connect"
          echo "Building target: $target"

          /home/runner/.platformio/penv/bin/platformio run \
            --project-dir /home/runner/meshtastic/ \
            -e "$target"

          if [ $? -eq 0 ]; then
            echo "Build Success!"
            build_dir="/home/runner/meshtastic/.pio/build/${target}"
            bin_files=("${build_dir}"/*.bin)
            
            if [ ${#bin_files[@]} -gt 0 ]; then
               zip -j "/home/runner/dists/${target}.zip" "${bin_files[@]}"
            else
               echo "ERROR: Build succeeded but no .bin files found."
               exit 1
            fi
          else
            echo "Build Failed."
            exit 1
          fi

      - name: Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nibble-zero-connect-firmware
          path: /home/runner/dists/*.zip
